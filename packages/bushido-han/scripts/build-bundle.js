#!/usr/bin/env bun
/**
 * Build script for han CLI binary.
 *
 * This script compiles the TypeScript source directly to a standalone binary
 * using `bun build --compile`. The native module (.node file) is embedded
 * automatically when using a bare `require()` with a static string path.
 *
 * Since bun build --compile doesn't support --define, we generate a build-info
 * file that gets imported by the main module.
 *
 * Usage:
 *   bun scripts/build-bundle.js [target]
 *
 * Targets:
 *   - bun (default, current platform)
 *   - bun-darwin-arm64
 *   - bun-darwin-x64
 *   - bun-linux-x64
 *   - bun-linux-arm64
 *   - bun-windows-x64
 */
import { readFileSync, mkdirSync, writeFileSync } from "node:fs";
import { dirname, join } from "node:path";
import { fileURLToPath } from "node:url";

const __dirname = dirname(fileURLToPath(import.meta.url));
const packageJson = JSON.parse(
	readFileSync(join(__dirname, "..", "package.json"), "utf-8"),
);

const version = packageJson.version;

// Read the detect-plugins prompt
const detectPluginsPrompt = readFileSync(
	join(__dirname, "..", "lib", "detect-plugins-prompt.md"),
	"utf-8",
);

const target = Bun.argv[2] || "bun";
const isCurrentPlatform = target === "bun";
const outfile = isCurrentPlatform
	? join(__dirname, "..", "dist", "han")
	: join(__dirname, "..", "dist", "binaries", `han-${target.replace("bun-", "")}`);

console.log(`Building han v${version} for ${target}...`);

// Ensure output directory exists
mkdirSync(dirname(outfile), { recursive: true });

// Generate build-info.ts with version and prompt embedded
const buildInfoPath = join(__dirname, "..", "lib", "build-info.generated.ts");
writeFileSync(
	buildInfoPath,
	`// Auto-generated by build-bundle.js - DO NOT EDIT
export const HAN_VERSION = ${JSON.stringify(version)};
export const DETECT_PLUGINS_PROMPT = ${JSON.stringify(detectPluginsPrompt)};
`,
);

// Compile using bun build --compile
const proc = Bun.spawn(
	[
		"bun",
		"build",
		"--compile",
		"--minify",
		`--target=${target}`,
		join(__dirname, "..", "lib", "main.ts"),
		"--outfile",
		outfile,
	],
	{
		cwd: join(__dirname, ".."),
		stdout: "inherit",
		stderr: "inherit",
	},
);

const exitCode = await proc.exited;
if (exitCode !== 0) {
	console.error("Build failed");
	process.exit(exitCode);
}

console.log(`Built successfully: ${outfile}`);
