#!/usr/bin/env bash
#
# Han wrapper with auto-install for ephemeral environments
#
# MCP servers and hooks use this as their entry point. If the han binary
# isn't installed, it downloads from GitHub releases (or npm as fallback).
#

set -e

HAN_BIN="${HAN_BIN:-$HOME/.local/bin/han-bin}"
HAN_REPO="${HAN_REPO:-TheBushidoCollective/han}"

# If binary exists, use it
if [ -x "$HAN_BIN" ]; then
    export HAN_BIN
    exec "$HAN_BIN" "$@"
fi

# Try to install the binary
BIN_DIR="$(dirname "$HAN_BIN")"
mkdir -p "$BIN_DIR"
LOCK_FILE="${BIN_DIR}/.han-install.lock"

# Use flock to prevent race conditions during parallel installs
(
    flock -n 200 || {
        # Another process is installing, wait for it
        flock 200
        # Installation done by other process, check if successful
        if [ -x "$HAN_BIN" ]; then
            exit 0
        fi
        echo "Installation by another process failed" >&2
        exit 1
    }

    # Double-check after acquiring lock (another process may have installed)
    if [ -x "$HAN_BIN" ]; then
        exit 0
    fi

    # Detect platform
    os="$(uname -s)"
    arch="$(uname -m)"
    case "$os" in
        Darwin)
            case "$arch" in
                arm64|aarch64) PLATFORM="darwin-arm64" ;;
                x86_64|amd64) PLATFORM="darwin-x64" ;;
                *) echo "Unsupported architecture: $arch" >&2; exit 1 ;;
            esac
            ;;
        Linux)
            case "$arch" in
                arm64|aarch64) PLATFORM="linux-arm64" ;;
                x86_64|amd64) PLATFORM="linux-x64" ;;
                *) echo "Unsupported architecture: $arch" >&2; exit 1 ;;
            esac
            ;;
        MINGW*|MSYS*|CYGWIN*) PLATFORM="win32-x64" ;;
        *) echo "Unsupported OS: $os" >&2; exit 1 ;;
    esac

    TEMP_BIN="${HAN_BIN}.tmp.$$"
    cleanup() { rm -f "$TEMP_BIN"; rm -rf "${TEMP_BIN}.dir"; }
    trap cleanup EXIT

    # Try GitHub releases first
    install_from_github() {
        echo "Fetching latest han version from GitHub..." >&2
        API_RESPONSE=$(curl -fsSL "https://api.github.com/repos/${HAN_REPO}/releases/latest" 2>&1) || return 1
        VERSION=$(echo "$API_RESPONSE" | grep '"tag_name":' | sed -E 's/.*"v?([^"]+)".*/\1/')
        [ -z "$VERSION" ] || [ "$VERSION" = "null" ] && return 1

        DOWNLOAD_URL="https://github.com/${HAN_REPO}/releases/download/v${VERSION}/han-${PLATFORM}"
        CHECKSUM_URL="${DOWNLOAD_URL}.sha256"

        echo "Downloading han v${VERSION} for ${PLATFORM}..." >&2
        curl -fSL --progress-bar "$DOWNLOAD_URL" -o "$TEMP_BIN" || return 1

        # Verify checksum if available
        TEMP_CHECKSUM="${TEMP_BIN}.sha256"
        if curl -fsSL "$CHECKSUM_URL" -o "$TEMP_CHECKSUM" 2>/dev/null; then
            EXPECTED=$(awk '{print $1}' "$TEMP_CHECKSUM")
            if [ -n "$EXPECTED" ]; then
                if command -v sha256sum >/dev/null 2>&1; then
                    ACTUAL=$(sha256sum "$TEMP_BIN" | awk '{print $1}')
                elif command -v shasum >/dev/null 2>&1; then
                    ACTUAL=$(shasum -a 256 "$TEMP_BIN" | awk '{print $1}')
                fi
                if [ -n "$ACTUAL" ] && [ "$EXPECTED" != "$ACTUAL" ]; then
                    echo "Checksum verification failed!" >&2
                    rm -f "$TEMP_CHECKSUM"
                    return 1
                fi
                echo "Checksum verified" >&2
            fi
            rm -f "$TEMP_CHECKSUM"
        fi

        chmod +x "$TEMP_BIN"
        mv -f "$TEMP_BIN" "$HAN_BIN"
        echo "Installed han v${VERSION}" >&2
    }

    # Fallback: install from npm
    install_from_npm() {
        command -v npm >/dev/null 2>&1 || return 1
        echo "Installing han from npm..." >&2

        TEMP_DIR="${TEMP_BIN}.dir"
        mkdir -p "$TEMP_DIR"
        NPM_PKG="@thebushidocollective/han-${PLATFORM}"

        (cd "$TEMP_DIR" && npm pack "$NPM_PKG" --silent 2>/dev/null) || return 1

        TARBALL=$(ls "$TEMP_DIR"/*.tgz 2>/dev/null | head -1)
        [ -f "$TARBALL" ] || return 1

        tar -xzf "$TARBALL" -C "$TEMP_DIR" || return 1

        [ -f "$TEMP_DIR/package/han" ] || return 1
        chmod +x "$TEMP_DIR/package/han"
        mv -f "$TEMP_DIR/package/han" "$HAN_BIN"
        echo "Installed han from npm" >&2
    }

    # Try GitHub first, then npm as fallback
    if ! install_from_github 2>/dev/null; then
        echo "GitHub download failed, trying npm..." >&2
        if ! install_from_npm; then
            echo "Failed to install han binary" >&2
            exit 1
        fi
    fi

) 200>"$LOCK_FILE"

# Run the binary
if [ -x "$HAN_BIN" ]; then
    export HAN_BIN
    exec "$HAN_BIN" "$@"
fi

echo "Error: Failed to install han binary" >&2
exit 1
