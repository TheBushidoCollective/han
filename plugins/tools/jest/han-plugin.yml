hooks:
  # Full test suite at Stop (checkpoint)
  test:
    command: |
      if [ -f bun.lock ] || [ -f bun.lockb ]; then bun run test
      elif [ -f pnpm-lock.yaml ]; then pnpm run test
      elif [ -f yarn.lock ]; then yarn test
      else npm run test; fi
    dirs_with:
      - "package.json"
    dir_test: "grep -qE '\"jest\":' package.json"
    if_changed:
      - "**/*.{js,jsx,ts,tsx,mjs,cjs}"
      - "**/*.test.{js,jsx,ts,tsx}"
      - "**/*.spec.{js,jsx,ts,tsx}"
      - "jest.config.*"

  # Single test file async validation on PostToolUse
  test-async:
    event: PostToolUse
    command: |
      if [ -f bun.lock ] || [ -f bun.lockb ]; then bun test ${HAN_FILES}
      elif [ -f pnpm-lock.yaml ]; then pnpm exec jest ${HAN_FILES}
      elif [ -f yarn.lock ]; then yarn jest ${HAN_FILES}
      else npx jest ${HAN_FILES}; fi
    dirs_with:
      - "package.json"
    dir_test: "grep -qE '\"jest\":' package.json"
    tool_filter:
      - Edit
      - Write
      - NotebookEdit
    file_filter:
      - "**/*.test.{js,jsx,ts,tsx}"
      - "**/*.spec.{js,jsx,ts,tsx}"
    # Only run if file contains test code (describe/it/test blocks)
    file_test: grep -qE "(describe|it|test)\s*\(" "${HAN_FILE}"
