---
workflow: default
created: 2026-01-30
---

# Memory System Improvements

## Problem

The han memory system bails too quickly on complex questions. When asked "which session discussed VCS strategy?", it:

1. Returns "low confidence" without actually searching
2. Claims it "doesn't have access" to data that exists in the database
3. Doesn't try multiple search strategies
4. Can't find sessions by topic because it only indexes individual messages

Current limitations:
- **Single-shot search** - Haiku agent tries one query and gives up
- **No session summaries** - Messages indexed, but not session-level topics
- **Semantic gap** - FTS misses "VCS" → "version control" connections
- **Silent failures** - Empty results return as "I don't have access"
- **Agent constraints** - Can only use MCP tools, no fallback to direct DB queries

## Solution

Make the memory system smarter through:

### 1. Session Summaries
Generate and index session-level summaries with topics, making "which session discussed X" queries possible.

### 2. Query Expansion
Automatically expand queries with related terms before searching:
- "VCS" → ["VCS", "version control", "git", "jj", "branching"]
- "auth" → ["auth", "authentication", "login", "OAuth", "JWT"]

### 3. Multi-Strategy Search
Agent should try multiple approaches before returning low confidence:
1. Direct FTS match
2. Semantic/vector search
3. Query expansion + FTS
4. Session summary search
5. Recent sessions scan

### 4. Transparent Failures
Report what was searched and what failed, not just "I don't have access":
- "Searched 147 sessions, 0 matches for 'VCS strategy'"
- "FTS returned 0 results, trying semantic search..."

### 5. Fallback Mechanisms
When MCP tools return empty, agent should be able to:
- Query the database directly
- Scan recent session transcripts
- Ask for clarification

## Success Criteria

### Session Summaries
- [ ] Generate session summary on session end (via Stop hook or indexer)
- [ ] Summary includes: main topics, files modified, tools used, outcome
- [ ] Summaries stored in searchable table with FTS
- [ ] Memory tool can query "sessions about X" and get relevant results

### Query Expansion
- [ ] Query expansion function that generates related terms
- [ ] Use embeddings or thesaurus for semantic expansion
- [ ] Expansion runs before FTS search
- [ ] Configurable expansion depth (1-3 levels)

### Multi-Strategy Search
- [ ] Agent tries at least 3 strategies before returning low confidence
- [ ] Strategies run in parallel where possible
- [ ] Results merged with deduplication
- [ ] Confidence increases with each successful strategy

### Transparent Failures
- [ ] Memory tool reports "searched X, found Y results"
- [ ] Empty results explain what was tried
- [ ] Suggestions for refining the query
- [ ] Never say "I don't have access" when data exists

### Fallback Mechanisms
- [ ] Direct database query fallback when MCP tools fail
- [ ] Recent sessions scan (last N sessions) for temporal queries
- [ ] Clarification prompts for ambiguous queries
- [ ] Hybrid search used by default, not as fallback

## Context

### Existing Code Locations
- `packages/han/lib/commands/mcp/server.ts` - Memory tool handler (lines 693-770)
- `packages/han/lib/memory/memory-agent.ts` - Agent spawning (lines 258-475)
- `packages/han/lib/memory/provider-discovery.ts` - Backend discovery
- `packages/han/lib/commands/mcp/dal.ts` - Search implementations
- `packages/han-native/src/` - Rust indexer for transcripts

### Current Data Flow
```
User Question
    ↓
MCP server.ts (queryMemoryAgent)
    ↓
memory-agent.ts (spawn Haiku agent)
    ↓
Agent calls memory_search_* tools
    ↓
dal.ts searches FTS/vector
    ↓
Results or silent empty
```

### Desired Data Flow
```
User Question
    ↓
Query Expansion (generate related terms)
    ↓
Multi-Strategy Search (parallel)
    ├── FTS on messages
    ├── Vector/semantic search
    ├── Session summary search
    └── Recent sessions scan
    ↓
Result Fusion (merge, dedupe, rank)
    ↓
Transparent Response (with search stats)
```

## Notes

- Session summaries could be generated by the indexer (Rust) or a post-indexing hook
- Query expansion could use a simple synonym map or embeddings
- Consider using Opus for complex questions, Haiku for simple lookups
- Multi-strategy should have timeout to prevent slow responses
