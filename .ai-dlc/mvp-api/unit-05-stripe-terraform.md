---
status: completed
depends_on: []
branch: ai-dlc/mvp-api/05-stripe-terraform
discipline: devops
---

# unit-05-stripe-terraform

## Description

Add Stripe Terraform provider to manage billing products, prices, and webhook endpoints as infrastructure-as-code.

## Discipline

devops - This unit will be executed by infrastructure-focused agents.

## Success Criteria

- [ ] Stripe provider added to `providers.tf` with version constraint
- [ ] `modules/stripe/` module created with proper structure
- [ ] `stripe_product` resource creates "Han FREE" product
- [ ] `stripe_product` resource creates "Han PRO" product
- [ ] `stripe_price` resource creates PRO monthly price ($10/month)
- [ ] `stripe_price` resource creates PRO yearly price ($100/year, ~17% discount)
- [ ] `stripe_webhook_endpoint` resource registers API webhook URL
- [ ] Webhook listens for: `customer.subscription.created`, `customer.subscription.updated`, `customer.subscription.deleted`, `invoice.payment_failed`
- [ ] Outputs include product IDs, price IDs, webhook secret
- [ ] Price IDs passed to API server as environment variables
- [ ] `STRIPE_WEBHOOK_SECRET` passed to API server as env var
- [ ] Variables added: `stripe_api_key` (sensitive)
- [ ] Documentation updated in terraform README

## Notes

**Stripe Terraform provider:**
```hcl
terraform {
  required_providers {
    stripe = {
      source  = "lukasaron/stripe"
      version = "~> 1.0"
    }
  }
}

provider "stripe" {
  api_key = var.stripe_api_key
}
```

**Module structure:**
```
modules/stripe/
  providers.tf
  products.tf      # Product resources
  prices.tf        # Price resources
  webhooks.tf      # Webhook endpoint
  inputs.tf
  outputs.tf
```

**Product metadata:**
```hcl
resource "stripe_product" "pro" {
  name        = "Han PRO"
  description = "Extended session retention, team features"
  metadata = {
    tier = "pro"
    retention_days = "365"
  }
}
```

**Webhook URL:**
- Production: `https://api.han.guru/api/v1/billing/webhook`
- The webhook secret is auto-generated by Stripe
