hooks:
  # Full project hooks at Stop (checkpoint)
  test:
    dirs_with:
      - "mix.exs"
    command: "mix test --stale"
    if_changed:
      - "**/*.ex"
      - "**/*.exs"
      - "**/*.eex"
      - "**/*.leex"
      - "**/*.heex"
      - "mix.exs"
      - "mix.lock"
  format:
    dirs_with:
      - ".formatter.exs"
    command: "mix format --check-formatted"
    if_changed:
      - "**/*.ex"
      - "**/*.exs"
      - "**/*.eex"
      - "**/*.leex"
      - "**/*.heex"
      - ".formatter.exs"
  build:
    dirs_with:
      - "mix.exs"
    command: "mix compile --warnings-as-errors"
    if_changed:
      - "**/*.ex"
      - "**/*.exs"
      - "**/*.eex"
      - "**/*.leex"
      - "**/*.heex"
      - "mix.exs"
      - "mix.lock"
  typecheck:
    dirs_with:
      - "mix.exs"
    command: "mix dialyzer"
    if_changed:
      - "**/*.ex"
      - "**/*.exs"
      - "**/*.eex"
      - "**/*.leex"
      - "**/*.heex"
      - "mix.exs"
      - "mix.lock"
  coverage:
    dirs_with:
      - "coveralls.json"
    # Only enforces coverage if minimum_coverage is set in coveralls.json
    command: "bash \"${CLAUDE_PLUGIN_ROOT}/scripts/coverage-ratchet.sh\""
    if_changed:
      - "**/*.ex"
      - "**/*.exs"
      - "mix.exs"
      - "mix.lock"
      - "coveralls.json"

  # Async hooks on PostToolUse - immediate feedback on file changes
  format-async:
    event: PostToolUse
    command: "mix format --check-formatted ${HAN_FILES}"
    dirs_with:
      - ".formatter.exs"
    tool_filter:
      - Edit
      - Write
    file_filter:
      - "**/*.ex"
      - "**/*.exs"

  compile-async:
    event: PostToolUse
    command: "mix compile --warnings-as-errors"
    dirs_with:
      - "mix.exs"
    tool_filter:
      - Edit
      - Write
    file_filter:
      - "**/*.ex"
      - "**/*.exs"

  test-async:
    event: PostToolUse
    command: "mix test ${HAN_FILES}"
    dirs_with:
      - "mix.exs"
    tool_filter:
      - Edit
      - Write
    file_filter:
      - "**/*_test.exs"
      - "**/test/**/*.exs"
    # Only run if file contains test code
    file_test: grep -qE "(describe|test|doctest)" "${HAN_FILE}"
