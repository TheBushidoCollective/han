name: Auto Fix CI Failures

on:
  workflow_run:
    workflows: ["Auto Tag Release", "Publish to NPM", "Test Website", "Validate Han Website"]
    types:
      - completed

permissions:
  contents: write
  pull-requests: write
  actions: read
  issues: write
  id-token: write

jobs:
  auto-fix:
    if: |
      github.event.workflow_run.conclusion == 'failure' &&
      !startsWith(github.event.workflow_run.head_branch, 'claude-auto-fix-')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup git identity
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

      - name: Check for concurrent auto-fix runs
        id: check_concurrent
        uses: actions/github-script@v7
        with:
          script: |
            // Get all running workflow runs for auto-fix
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'auto-fix-ci.yml',
              status: 'in_progress'
            });

            // Filter to runs for the same branch (excluding this run)
            const currentRunId = context.runId;
            const targetBranch = '${{ github.event.workflow_run.head_branch }}';
            const concurrentRuns = runs.data.workflow_runs.filter(
              run => run.id !== currentRunId &&
                     run.head_branch === targetBranch
            );

            if (concurrentRuns.length > 0) {
              console.log(`Found ${concurrentRuns.length} concurrent auto-fix run(s) for branch ${targetBranch}. Skipping.`);
              return { skip: true };
            }

            return { skip: false };

      - name: Get CI failure details
        if: fromJSON(steps.check_concurrent.outputs.result).skip != true
        id: failure_details
        uses: actions/github-script@v7
        with:
          script: |
            const run = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: ${{ github.event.workflow_run.id }}
            });

            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: ${{ github.event.workflow_run.id }}
            });

            const failedJobs = jobs.data.jobs.filter(job => job.conclusion === 'failure');

            let errorLogs = [];
            for (const job of failedJobs) {
              try {
                const logs = await github.rest.actions.downloadJobLogsForWorkflowRun({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  job_id: job.id
                });
                // Truncate logs to last 5000 chars to avoid token limits
                const truncatedLogs = logs.data.slice(-5000);
                errorLogs.push({
                  jobName: job.name,
                  logs: truncatedLogs
                });
              } catch (e) {
                errorLogs.push({
                  jobName: job.name,
                  logs: 'Could not fetch logs'
                });
              }
            }

            return {
              runUrl: run.data.html_url,
              failedJobs: failedJobs.map(j => j.name),
              errorLogs: errorLogs,
              workflowName: run.data.name
            };

      - name: Fix CI failures with Claude
        if: fromJSON(steps.check_concurrent.outputs.result).skip != true
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          prompt: |
            A CI workflow has failed. Please analyze the error and fix it.

            Workflow: ${{ fromJSON(steps.failure_details.outputs.result).workflowName }}
            Failed CI Run: ${{ fromJSON(steps.failure_details.outputs.result).runUrl }}
            Failed Jobs: ${{ join(fromJSON(steps.failure_details.outputs.result).failedJobs, ', ') }}
            Branch: ${{ github.event.workflow_run.head_branch }}
            Repository: ${{ github.repository }}

            Error logs:
            ${{ toJSON(fromJSON(steps.failure_details.outputs.result).errorLogs) }}

            Instructions:
            1. Analyze the error logs to understand what failed
            2. Make the minimal changes needed to fix the issue
            3. Do NOT commit or push - the workflow will handle that after you make changes
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

      - name: Commit and push fixes
        if: fromJSON(steps.check_concurrent.outputs.result).skip != true
        run: |
          # Check if there are any changes to commit
          if git diff --quiet && git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          # Stage all changes
          git add -A

          # Get the workflow name for the commit message
          WORKFLOW_NAME="${{ fromJSON(steps.failure_details.outputs.result).workflowName }}"

          # Commit with a descriptive message
          git commit -m "fix(ci): auto-fix ${WORKFLOW_NAME} failures

          Auto-fixed by Claude Code action.

          Original failure: ${{ fromJSON(steps.failure_details.outputs.result).runUrl }}

          Co-Authored-By: Claude <noreply@anthropic.com>"

          # Push the changes
          git push origin ${{ github.event.workflow_run.head_branch }}
