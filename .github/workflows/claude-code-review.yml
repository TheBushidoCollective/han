name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  claude-review:
    # Skip fork PRs (OIDC tokens not available for external forks)
    if: github.event.pull_request.head.repo.full_name == github.repository

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for diff analysis

      - name: Check for previous review
        id: check-review
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get ALL Claude review comments (for concern tracking)
          ALL_REVIEWS=$(gh pr view ${{ github.event.pull_request.number }} --json comments \
            --jq '[.comments[] | select(.body | contains("<!-- claude-review-commit:")) | .body]')

          # Get the FIRST review (original concerns)
          FIRST_REVIEW=$(echo "$ALL_REVIEWS" | jq -r '.[0] // empty')

          # Get the LAST review (most recent)
          LAST_REVIEW=$(echo "$ALL_REVIEWS" | jq -r '.[-1] // empty')

          # Count total reviews
          REVIEW_COUNT=$(echo "$ALL_REVIEWS" | jq 'length')
          echo "review_count=$REVIEW_COUNT" >> $GITHUB_OUTPUT

          if [ -n "$LAST_REVIEW" ]; then
            # Extract the commit SHA from the marker
            LAST_COMMIT=$(echo "$LAST_REVIEW" | grep -oP '<!-- claude-review-commit:\K[a-f0-9]+' || echo "")
            FIRST_COMMIT=$(echo "$FIRST_REVIEW" | grep -oP '<!-- claude-review-commit:\K[a-f0-9]+' || echo "")

            if [ -n "$LAST_COMMIT" ]; then
              echo "last_reviewed_commit=$LAST_COMMIT" >> $GITHUB_OUTPUT
              echo "first_reviewed_commit=$FIRST_COMMIT" >> $GITHUB_OUTPUT
              echo "has_previous_review=true" >> $GITHUB_OUTPUT

              # Calculate lines changed since last review
              LINES_CHANGED=$(git diff --shortstat "$LAST_COMMIT"..HEAD 2>/dev/null | awk '{sum=$4+$6} END {print sum+0}')
              echo "lines_changed=$LINES_CHANGED" >> $GITHUB_OUTPUT
              echo "Found $REVIEW_COUNT previous reviews, last at commit $LAST_COMMIT, $LINES_CHANGED lines changed since"
            else
              echo "has_previous_review=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "has_previous_review=false" >> $GITHUB_OUTPUT
          fi

      - name: Determine review mode
        id: review-mode
        run: |
          REVIEW_COUNT="${{ steps.check-review.outputs.review_count }}"

          if [ "${{ steps.check-review.outputs.has_previous_review }}" = "true" ]; then
            LINES="${{ steps.check-review.outputs.lines_changed }}"

            # Circuit breaker: After 3 reviews, switch to approval-focused mode
            if [ "${REVIEW_COUNT:-0}" -ge 3 ]; then
              echo "mode=closure" >> $GITHUB_OUTPUT
              echo "Closure mode: $REVIEW_COUNT reviews already - focusing on approval"
            elif [ "${LINES:-0}" -lt 50 ]; then
              echo "mode=verification" >> $GITHUB_OUTPUT
              echo "Verification mode: $LINES lines changed - checking if concerns addressed"
            else
              echo "mode=incremental" >> $GITHUB_OUTPUT
              echo "Incremental mode: $LINES lines changed - reviewing new changes"
            fi
          else
            echo "mode=initial" >> $GITHUB_OUTPUT
            echo "Initial review mode"
          fi

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          allowed_bots: "*"
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}
            CURRENT_COMMIT: ${{ github.sha }}
            REVIEW_MODE: ${{ steps.review-mode.outputs.mode }}
            LAST_REVIEWED_COMMIT: ${{ steps.check-review.outputs.last_reviewed_commit }}
            LINES_CHANGED: ${{ steps.check-review.outputs.lines_changed }}

            ${{ steps.review-mode.outputs.mode == 'initial' && '
            ## INITIAL REVIEW

            This is the first review of this PR. Please provide comprehensive feedback on:
            - Code quality and best practices
            - Potential bugs or issues
            - Performance considerations
            - Security concerns
            - Test coverage

            Categorize issues by severity: CRITICAL (must fix), MODERATE (should fix), MINOR (consider).

            IMPORTANT: This is your ONE chance to raise all concerns. After this review, you will
            only be verifying if these concerns were addressed - you should NOT raise new issues
            on follow-up reviews unless they are CRITICAL security/data-loss bugs in newly added code.

            Be thorough but reasonable. The goal is to ship good code, not perfect code.
            ' || '' }}

            ${{ steps.review-mode.outputs.mode == 'verification' && format('
            ## VERIFICATION MODE (Follow-up Review #{2})

            This PR has been reviewed {2} time(s). Only {0} lines changed since commit {1}.

            YOUR ONLY TASK: Check if ORIGINAL concerns from the FIRST review were addressed.

            STEP-BY-STEP PROCESS:
            1. Use `gh pr view {3} --json comments` to read ALL previous review comments
            2. Extract the concerns from your FIRST review (the original issues raised)
            3. Check PR comments for author responses/explanations
            4. Use `git diff {1}..HEAD` to see recent changes
            5. For EACH original concern, mark it as:
               - ✅ ADDRESSED via code change
               - ✅ ADDRESSED via discussion (author explained why its fine)
               - ⏳ STILL PENDING (only if truly blocking)

            STRICT RULES:
            - Do NOT raise ANY new issues. Your initial review was your chance.
            - Do NOT re-review code you already approved
            - If author explains why they disagree, ACCEPT their reasoning unless its dangerous
            - Stylistic preferences that author declined = ADDRESSED (respect their choice)
            - The goal is CLOSURE, not perfection

            RESPOND WITH:
            1. Brief status of each original concern (1 line each)
            2. Overall verdict: APPROVE or specific blocking items

            Keep it SHORT. If all addressed: "LGTM - all concerns addressed" is ideal.
            ', steps.check-review.outputs.lines_changed, steps.check-review.outputs.last_reviewed_commit, steps.check-review.outputs.review_count, github.event.pull_request.number) || '' }}

            ${{ steps.review-mode.outputs.mode == 'incremental' && format('
            ## INCREMENTAL REVIEW (Follow-up #{2})

            This PR has been reviewed {2} time(s). {0} lines changed since commit {1}.

            YOUR TASK: Track original concerns AND review substantial new code.

            STEP-BY-STEP PROCESS:
            1. Use `gh pr view {3} --json comments` to read ALL previous reviews
            2. List concerns from your FIRST review - these are what you are tracking
            3. Check which original concerns are now addressed (code or discussion)
            4. Use `git diff {1}..HEAD` to review NEW changes only
            5. ONLY raise new issues if they are CRITICAL bugs in the new code

            STRICT RULES:
            - Track and close ORIGINAL concerns - thats your primary job
            - New issues ONLY for: security holes, data loss, crashes in NEW code
            - Do NOT raise style/preference issues on new code
            - Do NOT re-review unchanged code
            - If author explained why they wont fix something, mark it ADDRESSED
            - The goal is CLOSURE and forward progress

            RESPOND WITH:
            1. Status of original concerns (✅ addressed or ⏳ pending)
            2. Any CRITICAL issues in new code (rare - only if truly dangerous)
            3. Overall verdict: APPROVE or specific blockers

            Lean towards approval. Ship good code, not perfect code.
            ', steps.check-review.outputs.lines_changed, steps.check-review.outputs.last_reviewed_commit, steps.check-review.outputs.review_count, github.event.pull_request.number) || '' }}

            ${{ steps.review-mode.outputs.mode == 'closure' && format('
            ## CLOSURE MODE (Review #{0} - Time to Ship)

            This PR has been reviewed {0} times. It is time to bring this to closure.

            YOUR TASK: Approve unless there is a CRITICAL blocking issue.

            RULES:
            - APPROVE unless there is a security vulnerability, data loss risk, or crash
            - All previous stylistic/preference concerns are now MOOT - author had chances to address
            - Do NOT raise any new issues of any kind
            - If original blocking concerns exist, list them briefly, otherwise APPROVE

            RESPOND WITH ONE OF:
            - "LGTM - Approving after {0} review cycles"
            - "Blocking: [specific critical issue]" (only for security/crash/data-loss)

            The goal is to SHIP. Perfect is the enemy of good.
            ', steps.check-review.outputs.review_count) || '' }}

            Use the repository's CLAUDE.md for guidance on style and conventions.

            IMPORTANT: End your comment with this exact marker (for tracking):
            <!-- claude-review-commit:${{ github.sha }} -->

            Use `gh pr comment` with your Bash tool to leave your review as a comment on the PR.

          claude_args: '--allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*),Bash(git diff:*),Bash(git log:*)"'

