name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          additional_permissions: |
            actions: read

      - name: Check for changes and create PR
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if there are any changes
          if [ -z "$(git status --porcelain)" ]; then
            echo "No changes to commit"
            exit 0
          fi

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Determine if we're on a PR or issue
          IS_PR="false"
          if [ "${{ github.event_name }}" = "pull_request_review_comment" ] || [ "${{ github.event_name }}" = "pull_request_review" ]; then
            IS_PR="true"
            NUMBER="${{ github.event.pull_request.number }}"
            TITLE="${{ github.event.pull_request.title }}"
            HEAD_REF="${{ github.event.pull_request.head.ref }}"
          elif [ "${{ github.event_name }}" = "issue_comment" ]; then
            # Check if this issue is actually a PR
            if gh pr view "${{ github.event.issue.number }}" &>/dev/null; then
              IS_PR="true"
              NUMBER="${{ github.event.issue.number }}"
              TITLE="${{ github.event.issue.title }}"
              HEAD_REF=$(gh pr view "$NUMBER" --json headRefName -q '.headRefName')
            else
              NUMBER="${{ github.event.issue.number }}"
              TITLE="${{ github.event.issue.title }}"
            fi
          elif [ "${{ github.event_name }}" = "issues" ]; then
            NUMBER="${{ github.event.issue.number }}"
            TITLE="${{ github.event.issue.title }}"
          else
            NUMBER="$(date +%s)"
            TITLE="Claude Code changes"
          fi

          # If we're on a PR, push to the existing branch
          if [ "$IS_PR" = "true" ]; then
            echo "Pushing changes to existing PR branch: $HEAD_REF"

            # Fetch and checkout the PR branch
            git fetch origin "$HEAD_REF"
            git checkout "$HEAD_REF"

            # Stage and commit
            git add -A
            git commit -m "fix: address feedback from #${NUMBER}

          Automatically generated by Claude Code in response to @claude mention.

          ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

          Co-Authored-By: Claude <noreply@anthropic.com>"

            # Push to PR branch
            git push origin "$HEAD_REF"
            echo "âœ… Pushed changes to PR #${NUMBER}"
          else
            # Create a new branch and PR for issues
            BRANCH="claude/issue-${NUMBER}-$(date +%s)"

            git checkout -b "$BRANCH"

            git add -A
            git commit -m "feat: implement changes requested in #${NUMBER}

          Automatically generated by Claude Code in response to @claude mention.

          ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

          Co-Authored-By: Claude <noreply@anthropic.com>"

            git push origin "$BRANCH"

            # Create PR
            gh pr create \
              --title "feat: ${TITLE}" \
              --body "## Summary

          This PR was automatically created by Claude Code in response to a request in #${NUMBER}.

          ## Changes

          See commit history for details.

          ## Related

          Closes #${NUMBER}

          ---
          ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)" \
              --head "$BRANCH" \
              --base main

            echo "âœ… Created PR from branch $BRANCH"
          fi

