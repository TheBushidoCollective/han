name: Release Binaries

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release (e.g., v1.18.2)'
        required: true
        type: string
  repository_dispatch:
    types: [release]
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            bun_target: bun-linux-x64
            native_file: han-native.linux-x64-gnu.node
            binary_name: han-linux-x64
            cargo_output: libhan_native.so
          - target: aarch64-unknown-linux-gnu
            bun_target: bun-linux-arm64
            native_file: han-native.linux-arm64-gnu.node
            binary_name: han-linux-arm64
            cargo_output: libhan_native.so
          - target: x86_64-apple-darwin
            bun_target: bun-darwin-x64
            native_file: han-native.darwin-x64.node
            binary_name: han-darwin-x64
            cargo_output: libhan_native.dylib
          - target: aarch64-apple-darwin
            bun_target: bun-darwin-arm64
            native_file: han-native.darwin-arm64.node
            binary_name: han-darwin-arm64
            cargo_output: libhan_native.dylib
          - target: x86_64-pc-windows-msvc
            bun_target: bun-windows-x64
            native_file: han-native.win32-x64-msvc.node
            binary_name: han-windows-x64
            cargo_output: han_native.dll

    runs-on: ${{ contains(matrix.target, 'aarch64-unknown-linux') && 'ubuntu-24.04-arm' || 'ubuntu-latest' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag || github.event.client_payload.tag || github.ref }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Setup Zig
        if: ${{ !contains(matrix.target, 'windows') }}
        uses: mlugg/setup-zig@v2
        with:
          version: 0.13.0

      - name: Install cargo-zigbuild
        if: ${{ !contains(matrix.target, 'windows') }}
        uses: taiki-e/install-action@v2
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          tool: cargo-zigbuild

      - name: Install cargo-xwin
        if: contains(matrix.target, 'windows')
        uses: taiki-e/install-action@v2
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          tool: cargo-xwin

      - name: Install cross-compilation dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu protobuf-compiler

      - name: Install LLVM and NASM (for Windows builds)
        if: contains(matrix.target, 'windows')
        run: |
          sudo apt-get install -y llvm clang nasm

      - name: Install han-native dependencies
        working-directory: ./packages/han-native
        run: npm ci

      - name: Build native module (zigbuild for Linux)
        if: contains(matrix.target, 'linux')
        working-directory: ./packages/han-native
        shell: bash
        run: |
          cargo zigbuild --release --target ${{ matrix.target }}
          cp target/${{ matrix.target }}/release/${{ matrix.cargo_output }} ${{ matrix.native_file }}
          echo "Built native module:"
          ls -la *.node

      - name: Build native module (zigbuild for Darwin via Docker)
        if: contains(matrix.target, 'apple')
        shell: bash
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/io \
            -w /io/packages/han-native \
            ghcr.io/rust-cross/cargo-zigbuild:latest \
            bash -c "rustup update stable && rustup default stable && rustup target add ${{ matrix.target }} && cargo zigbuild --release --target ${{ matrix.target }}"
          cp packages/han-native/target/${{ matrix.target }}/release/${{ matrix.cargo_output }} packages/han-native/${{ matrix.native_file }}
          echo "Built native module:"
          ls -la packages/han-native/*.node

      - name: Build native module (xwin)
        if: contains(matrix.target, 'windows')
        working-directory: ./packages/han-native
        shell: bash
        run: |
          cargo xwin build --release --target ${{ matrix.target }}
          cp target/${{ matrix.target }}/release/${{ matrix.cargo_output }} ${{ matrix.native_file }}
          echo "Built native module:"
          ls -la *.node

      - name: Build bun binary
        shell: bash
        run: |
          cd packages/han
          bun install
          mkdir -p native
          cp ../han-native/${{ matrix.native_file }} native/han-native.node

          echo "Prepared native module for embedding:"
          ls -la native/

          # Build bun binary with embedded native module
          mkdir -p dist/binaries
          bun scripts/build-bundle.js ${{ matrix.bun_target }}

          echo "Built binary:"
          ls -la dist/binaries/

      - name: Create checksum
        working-directory: ./packages/han/dist/binaries
        run: |
          if [ -f "${{ matrix.binary_name }}.exe" ]; then
            sha256sum ${{ matrix.binary_name }}.exe > ${{ matrix.binary_name }}.exe.sha256
          else
            sha256sum ${{ matrix.binary_name }} > ${{ matrix.binary_name }}.sha256
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.binary_name }}
          path: |
            packages/han/dist/binaries/${{ matrix.binary_name }}${{ contains(matrix.target, 'windows') && '.exe' || '' }}
            packages/han/dist/binaries/${{ matrix.binary_name }}${{ contains(matrix.target, 'windows') && '.exe' || '' }}.sha256

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir -p release
          cp artifacts/han-linux-x64/* release/
          cp artifacts/han-linux-arm64/* release/
          cp artifacts/han-darwin-x64/* release/
          cp artifacts/han-darwin-arm64/* release/
          cp artifacts/han-windows-x64/* release/
          echo "Release files:"
          ls -la release/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.tag || github.event.client_payload.tag || github.ref_name }}
          files: release/*
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(inputs.tag || github.event.client_payload.tag || github.ref, '-') }}

  update-homebrew:
    needs: release
    runs-on: ubuntu-latest
    if: ${{ !contains(inputs.tag || github.event.client_payload.tag || github.ref, '-') }}
    steps:
      - name: Checkout homebrew-tap
        uses: actions/checkout@v4
        with:
          repository: TheBushidoCollective/homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap

      - name: Update formula
        env:
          VERSION: ${{ inputs.tag || github.event.client_payload.tag || github.ref_name }}
        run: |
          VERSION="${VERSION#v}"
          REPO="TheBushidoCollective/han"
          BASE_URL="https://github.com/${REPO}/releases/download/v${VERSION}"

          DARWIN_ARM64_SHA=$(curl -fsSL "${BASE_URL}/han-darwin-arm64.sha256" | awk '{print $1}')
          DARWIN_X64_SHA=$(curl -fsSL "${BASE_URL}/han-darwin-x64.sha256" | awk '{print $1}')
          LINUX_ARM64_SHA=$(curl -fsSL "${BASE_URL}/han-linux-arm64.sha256" | awk '{print $1}')
          LINUX_X64_SHA=$(curl -fsSL "${BASE_URL}/han-linux-x64.sha256" | awk '{print $1}')

          cat > homebrew-tap/Formula/han.rb << EOF
          # typed: false
          # frozen_string_literal: true

          class Han < Formula
            desc "Sophisticated Claude Code Plugins with Superior Accuracy"
            homepage "https://han.guru"
            version "${VERSION}"
            license "MIT"

            on_macos do
              if Hardware::CPU.arm?
                url "https://github.com/TheBushidoCollective/han/releases/download/v${VERSION}/han-darwin-arm64"
                sha256 "${DARWIN_ARM64_SHA}"
              else
                url "https://github.com/TheBushidoCollective/han/releases/download/v${VERSION}/han-darwin-x64"
                sha256 "${DARWIN_X64_SHA}"
              end
            end

            on_linux do
              if Hardware::CPU.arm?
                url "https://github.com/TheBushidoCollective/han/releases/download/v${VERSION}/han-linux-arm64"
                sha256 "${LINUX_ARM64_SHA}"
              else
                url "https://github.com/TheBushidoCollective/han/releases/download/v${VERSION}/han-linux-x64"
                sha256 "${LINUX_X64_SHA}"
              end
            end

            def install
              bin.install Dir["han-*"].first => "han"
            end

            test do
              assert_match version.to_s, shell_output("#{bin}/han --version")
            end
          end
          EOF

      - name: Commit and push
        working-directory: homebrew-tap
        env:
          TAG: ${{ inputs.tag || github.event.client_payload.tag || github.ref_name }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/han.rb
          git commit -m "Update han to ${TAG}"
          git push

  publish-npm:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    strategy:
      matrix:
        include:
          - artifact: han-linux-x64
            npm_platform: linux-x64
          - artifact: han-linux-arm64
            npm_platform: linux-arm64
          - artifact: han-darwin-x64
            npm_platform: darwin-x64
          - artifact: han-darwin-arm64
            npm_platform: darwin-arm64
          - artifact: han-windows-x64
            npm_platform: win32-x64
    steps:
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          registry-url: 'https://registry.npmjs.org'

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: artifact

      - name: Create npm package
        env:
          VERSION: ${{ inputs.tag || github.event.client_payload.tag || github.ref_name }}
          PLATFORM: ${{ matrix.npm_platform }}
        run: |
          VERSION="${VERSION#v}"
          mkdir -p package

          # Copy binary (handle .exe for Windows)
          if [ -f "artifact/${{ matrix.artifact }}.exe" ]; then
            cp "artifact/${{ matrix.artifact }}.exe" package/han.exe
          else
            cp "artifact/${{ matrix.artifact }}" package/han
            chmod +x package/han
          fi

          # Copy native module if present (for environments that need it separately)
          # The binary has it embedded, but some advanced use cases may need it

          cat > package/package.json << EOF
          {
            "name": "@thebushidocollective/han-${PLATFORM}",
            "version": "${VERSION}",
            "description": "Han CLI binary for ${PLATFORM}",
            "homepage": "https://han.guru",
            "license": "MIT",
            "repository": {
              "type": "git",
              "url": "https://github.com/TheBushidoCollective/han"
            },
            "os": ["${PLATFORM%-*}"],
            "cpu": ["${PLATFORM#*-}"]
          }
          EOF

          cat > package/README.md << EOF
          # Han CLI - ${PLATFORM}

          Platform-specific binary for [Han](https://han.guru), a Claude Code plugin marketplace.

          This package is automatically installed as a fallback when GitHub releases are unavailable.
          EOF

          echo "Package contents:"
          ls -la package/

      - name: Publish to npm
        working-directory: package
        run: npm publish --provenance --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  publish-wrapper:
    needs: publish-npm
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          registry-url: 'https://registry.npmjs.org'

      - name: Create wrapper package
        env:
          VERSION: ${{ inputs.tag || github.event.client_payload.tag || github.ref_name }}
        run: |
          VERSION="${VERSION#v}"
          mkdir -p package

          # Create the wrapper bin script
          cat > package/bin.js << 'BINEOF'
#!/usr/bin/env node
const { execFileSync } = require('child_process');
const { existsSync } = require('fs');
const { join } = require('path');

const platform = process.platform;
const arch = process.arch;

// Map Node.js platform/arch to our package names
const platformMap = {
  'darwin-arm64': 'darwin-arm64',
  'darwin-x64': 'darwin-x64',
  'linux-arm64': 'linux-arm64',
  'linux-x64': 'linux-x64',
  'win32-x64': 'win32-x64',
};

const key = `${platform}-${arch}`;
const pkgName = platformMap[key];

if (!pkgName) {
  console.error(`Unsupported platform: ${platform}-${arch}`);
  process.exit(1);
}

// Try to find the binary in node_modules
const binName = platform === 'win32' ? 'han.exe' : 'han';
const paths = [
  // Installed as dependency
  join(__dirname, '..', '@thebushidocollective', `han-${pkgName}`, binName),
  // npx cache location
  join(__dirname, 'node_modules', '@thebushidocollective', `han-${pkgName}`, binName),
];

let binPath = paths.find(p => existsSync(p));

if (!binPath) {
  // Try to install the platform package on-demand
  try {
    const pkg = `@thebushidocollective/han-${pkgName}`;
    console.error(`Installing ${pkg}...`);
    execFileSync('npm', ['install', '--no-save', pkg], {
      stdio: 'inherit',
      cwd: __dirname
    });
    binPath = join(__dirname, 'node_modules', '@thebushidocollective', `han-${pkgName}`, binName);
  } catch (e) {
    console.error(`Failed to install platform package: ${e.message}`);
    process.exit(1);
  }
}

if (!existsSync(binPath)) {
  console.error(`Binary not found at ${binPath}`);
  process.exit(1);
}

// Execute the binary with all arguments
try {
  execFileSync(binPath, process.argv.slice(2), { stdio: 'inherit' });
} catch (e) {
  process.exit(e.status || 1);
}
BINEOF

          chmod +x package/bin.js

          cat > package/package.json << EOF
{
  "name": "@thebushidocollective/han",
  "version": "${VERSION}",
  "description": "CLI for installing and managing curated Claude Code plugins from the Han marketplace",
  "homepage": "https://han.guru",
  "license": "MIT",
  "repository": {
    "type": "git",
    "url": "https://github.com/TheBushidoCollective/han"
  },
  "bin": {
    "han": "bin.js"
  },
  "optionalDependencies": {
    "@thebushidocollective/han-darwin-arm64": "${VERSION}",
    "@thebushidocollective/han-darwin-x64": "${VERSION}",
    "@thebushidocollective/han-linux-arm64": "${VERSION}",
    "@thebushidocollective/han-linux-x64": "${VERSION}",
    "@thebushidocollective/han-win32-x64": "${VERSION}"
  },
  "keywords": [
    "claude",
    "claude-code",
    "plugins",
    "mcp",
    "han",
    "bushido"
  ]
}
EOF

          cat > package/README.md << 'EOF'
# Han CLI

CLI for installing and managing curated Claude Code plugins from the [Han marketplace](https://han.guru).

## Usage

```bash
# Run directly via npx
npx @thebushidocollective/han plugin install --auto

# Or install globally
npm install -g @thebushidocollective/han
han plugin list
```

## MCP Server Usage

Configure in your Claude Code plugin:

```json
{
  "mcpServers": {
    "han": {
      "command": "npx",
      "args": ["-y", "@thebushidocollective/han", "mcp"]
    }
  }
}
```
EOF

          echo "Wrapper package contents:"
          ls -la package/
          cat package/package.json

      - name: Publish wrapper to npm
        working-directory: package
        run: npm publish --provenance --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
