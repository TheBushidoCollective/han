name: Release Binaries

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  id-token: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          registry-url: 'https://registry.npmjs.org'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        working-directory: ./packages/bushido-han
        run: npm ci

      - name: Build bundle
        working-directory: ./packages/bushido-han
        run: npm run build:bundle

      - name: Cross-compile binaries
        working-directory: ./packages/bushido-han
        run: |
          mkdir -p dist/binaries

          # Cross-compile for all platforms from single machine
          bun build --compile --minify --target=bun-darwin-arm64 ./dist/bundle.js --outfile ./dist/binaries/han-darwin-arm64
          bun build --compile --minify --target=bun-darwin-x64 ./dist/bundle.js --outfile ./dist/binaries/han-darwin-x64
          bun build --compile --minify --target=bun-linux-x64 ./dist/bundle.js --outfile ./dist/binaries/han-linux-x64
          bun build --compile --minify --target=bun-linux-arm64 ./dist/bundle.js --outfile ./dist/binaries/han-linux-arm64
          bun build --compile --minify --target=bun-windows-x64 ./dist/bundle.js --outfile ./dist/binaries/han-windows-x64.exe

      - name: Create checksums
        working-directory: ./packages/bushido-han/dist/binaries
        run: |
          for file in *; do
            sha256sum "$file" > "$file.sha256"
          done

      - name: Build platform packages for npm
        working-directory: ./packages/bushido-han
        run: node scripts/build-platform-packages.js

      - name: Publish platform packages to npm
        working-directory: ./packages/bushido-han
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          for pkg in dist/npm/*; do
            if [ -d "$pkg" ]; then
              echo "Publishing $pkg..."
              cd "$pkg"
              npm publish --provenance --access public || echo "Failed to publish $pkg (may already exist)"
              cd - > /dev/null
            fi
          done

      - name: Build TypeScript
        working-directory: ./packages/bushido-han
        run: npm run build

      - name: Publish main package to npm
        working-directory: ./packages/bushido-han
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: npm publish --provenance --access public || echo "Failed to publish main package (may already exist)"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            packages/bushido-han/dist/binaries/*
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref, '-') }}

  update-homebrew:
    needs: build-and-release
    runs-on: ubuntu-latest
    if: ${{ !contains(github.ref, '-') }}  # Skip for prereleases
    steps:
      - name: Checkout homebrew-tap
        uses: actions/checkout@v4
        with:
          repository: TheBushidoCollective/homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap

      - name: Update formula
        env:
          VERSION: ${{ github.ref_name }}
        run: |
          VERSION="${VERSION#v}"
          REPO="TheBushidoCollective/han"
          BASE_URL="https://github.com/${REPO}/releases/download/v${VERSION}"

          # Download checksum files
          DARWIN_ARM64_SHA=$(curl -fsSL "${BASE_URL}/han-darwin-arm64.sha256" | awk '{print $1}')
          DARWIN_X64_SHA=$(curl -fsSL "${BASE_URL}/han-darwin-x64.sha256" | awk '{print $1}')
          LINUX_ARM64_SHA=$(curl -fsSL "${BASE_URL}/han-linux-arm64.sha256" | awk '{print $1}')
          LINUX_X64_SHA=$(curl -fsSL "${BASE_URL}/han-linux-x64.sha256" | awk '{print $1}')

          cat > homebrew-tap/Formula/han.rb << EOF
          # typed: false
          # frozen_string_literal: true

          class Han < Formula
            desc "Sophisticated Claude Code Plugins with Superior Accuracy"
            homepage "https://han.guru"
            version "${VERSION}"
            license "MIT"

            on_macos do
              if Hardware::CPU.arm?
                url "https://github.com/TheBushidoCollective/han/releases/download/v${VERSION}/han-darwin-arm64"
                sha256 "${DARWIN_ARM64_SHA}"
              else
                url "https://github.com/TheBushidoCollective/han/releases/download/v${VERSION}/han-darwin-x64"
                sha256 "${DARWIN_X64_SHA}"
              end
            end

            on_linux do
              if Hardware::CPU.arm?
                url "https://github.com/TheBushidoCollective/han/releases/download/v${VERSION}/han-linux-arm64"
                sha256 "${LINUX_ARM64_SHA}"
              else
                url "https://github.com/TheBushidoCollective/han/releases/download/v${VERSION}/han-linux-x64"
                sha256 "${LINUX_X64_SHA}"
              end
            end

            def install
              bin.install Dir["*"].first => "han"
            end

            test do
              assert_match version.to_s, shell_output("#{bin}/han --version")
            end
          end
          EOF

      - name: Commit and push
        working-directory: homebrew-tap
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/han.rb
          git commit -m "Update han to ${GITHUB_REF_NAME}"
          git push
