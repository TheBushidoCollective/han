name: Release Binaries

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release (e.g., v1.18.2)'
        required: true
        type: string

permissions:
  contents: write
  id-token: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            bun_target: bun-linux-x64
            native_file: han-native.linux-x64-gnu.node
            binary_name: han-linux-x64
            cargo_output: libhan_native.so
          - target: aarch64-unknown-linux-gnu
            bun_target: bun-linux-arm64
            native_file: han-native.linux-arm64-gnu.node
            binary_name: han-linux-arm64
            cargo_output: libhan_native.so
          - target: x86_64-apple-darwin
            bun_target: bun-darwin-x64
            native_file: han-native.darwin-x64.node
            binary_name: han-darwin-x64
            cargo_output: libhan_native.dylib
          - target: aarch64-apple-darwin
            bun_target: bun-darwin-arm64
            native_file: han-native.darwin-arm64.node
            binary_name: han-darwin-arm64
            cargo_output: libhan_native.dylib

    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag || github.ref }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.13.0

      - name: Install cargo-zigbuild
        uses: taiki-e/install-action@v2
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          tool: cargo-zigbuild

      - name: Install cross-compilation dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Download macOS SDK (for darwin targets)
        if: contains(matrix.target, 'apple')
        run: |
          curl -L "https://github.com/phracker/MacOSX-SDKs/releases/download/11.3/MacOSX11.3.sdk.tar.xz" | tar -J -x -C /opt

      - name: Install han-native dependencies
        working-directory: ./packages/han-native
        run: npm ci

      - name: Build native module with cargo zigbuild
        working-directory: ./packages/han-native
        env:
          SDKROOT: ${{ contains(matrix.target, 'apple') && '/opt/MacOSX11.3.sdk' || '' }}
        run: |
          cargo zigbuild --release --target ${{ matrix.target }}
          cp target/${{ matrix.target }}/release/${{ matrix.cargo_output }} ${{ matrix.native_file }}
          echo "Built native module:"
          ls -la *.node

      - name: Build bun binary
        run: |
          cd packages/han
          npm ci
          mkdir -p native
          cp ../han-native/${{ matrix.native_file }} native/han-native.node

          echo "Prepared native module for embedding:"
          ls -la native/

          # Build bun binary with embedded native module
          mkdir -p dist/binaries
          bun scripts/build-bundle.js ${{ matrix.bun_target }}

          echo "Built binary:"
          ls -la dist/binaries/

      - name: Create checksum
        working-directory: ./packages/han/dist/binaries
        run: sha256sum ${{ matrix.binary_name }} > ${{ matrix.binary_name }}.sha256

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.binary_name }}
          path: |
            packages/han/dist/binaries/${{ matrix.binary_name }}
            packages/han/dist/binaries/${{ matrix.binary_name }}.sha256

      - name: Upload native module artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.native_file }}
          path: packages/han-native/${{ matrix.native_file }}

  # Windows needs native build due to libnode.dll requirement
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag || github.ref }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install han-native dependencies
        working-directory: ./packages/han-native
        run: npm ci

      - name: Build native module
        working-directory: ./packages/han-native
        run: npx napi build --platform --release

      - name: Build bun binary
        run: |
          cd packages/han
          npm ci
          mkdir -p native
          cp ../han-native/han-native.win32-x64-msvc.node native/han-native.node
          mkdir -p dist/binaries
          bun scripts/build-bundle.js bun-windows-x64
        shell: bash

      - name: Create checksum
        working-directory: ./packages/han/dist/binaries
        run: sha256sum han-windows-x64 > han-windows-x64.sha256
        shell: bash

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: han-windows-x64
          path: |
            packages/han/dist/binaries/han-windows-x64
            packages/han/dist/binaries/han-windows-x64.sha256

      - name: Upload native module artifact
        uses: actions/upload-artifact@v4
        with:
          name: han-native.win32-x64-msvc.node
          path: packages/han-native/han-native.win32-x64-msvc.node

  release:
    needs: [build, build-windows]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag || github.ref }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          registry-url: 'https://registry.npmjs.org'

      - name: Download all binary artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir -p release
          # Copy binaries and checksums
          cp artifacts/han-linux-x64/* release/ || true
          cp artifacts/han-linux-arm64/* release/ || true
          cp artifacts/han-darwin-x64/* release/ || true
          cp artifacts/han-darwin-arm64/* release/ || true
          cp artifacts/han-windows-x64/* release/ || true
          echo "Release files:"
          ls -la release/

      - name: Prepare native modules for npm
        run: |
          mkdir -p native-modules
          cp artifacts/han-native.linux-x64-gnu.node/han-native.linux-x64-gnu.node native-modules/ || true
          cp artifacts/han-native.linux-arm64-gnu.node/han-native.linux-arm64-gnu.node native-modules/ || true
          cp artifacts/han-native.darwin-x64.node/han-native.darwin-x64.node native-modules/ || true
          cp artifacts/han-native.darwin-arm64.node/han-native.darwin-arm64.node native-modules/ || true
          cp artifacts/han-native.win32-x64-msvc.node/han-native.win32-x64-msvc.node native-modules/ || true
          echo "Native modules:"
          ls -la native-modules/

      - name: Copy native modules to han-native package
        run: cp native-modules/*.node packages/han-native/

      - name: Install han dependencies
        working-directory: ./packages/han
        run: npm ci

      - name: Build platform packages for npm
        working-directory: ./packages/han
        run: node scripts/build-platform-packages.js

      - name: Publish platform packages to npm
        working-directory: ./packages/han
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          for pkg in dist/npm/*; do
            if [ -d "$pkg" ]; then
              echo "Publishing $pkg..."
              cd "$pkg"
              npm publish --provenance --access public || echo "Failed to publish $pkg (may already exist)"
              cd - > /dev/null
            fi
          done

      - name: Sync optionalDependencies versions
        working-directory: ./packages/han
        run: node scripts/sync-platform-versions.js

      - name: Verify platform packages are available on npm
        working-directory: ./packages/han
        run: |
          VERSION=$(node -p "require('./package.json').version")
          PACKAGES=(
            "@thebushidocollective/han-darwin-arm64"
            "@thebushidocollective/han-darwin-x64"
            "@thebushidocollective/han-linux-x64"
            "@thebushidocollective/han-linux-arm64"
            "@thebushidocollective/han-win32-x64"
          )

          echo "Verifying all platform packages are available at version $VERSION..."

          for pkg in "${PACKAGES[@]}"; do
            echo "Checking $pkg@$VERSION..."
            MAX_RETRIES=30
            RETRY_COUNT=0

            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if npm view "$pkg@$VERSION" version 2>/dev/null | grep -q "$VERSION"; then
                echo "✓ $pkg@$VERSION is available"
                break
              fi

              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
                echo "✗ $pkg@$VERSION not available after $MAX_RETRIES attempts"
                exit 1
              fi

              echo "  Waiting for $pkg@$VERSION to propagate (attempt $RETRY_COUNT/$MAX_RETRIES)..."
              sleep 10
            done
          done

          echo "All platform packages verified!"

      - name: Wait for CDN propagation
        run: |
          echo "Waiting 90 seconds for npm CDN propagation before publishing main package..."
          sleep 90

      - name: Publish main package to npm
        working-directory: ./packages/han
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: npm publish --provenance --access public || echo "Failed to publish main package (may already exist)"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.tag || github.ref_name }}
          files: release/*
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(inputs.tag || github.ref, '-') }}

  update-homebrew:
    needs: release
    runs-on: ubuntu-latest
    if: ${{ !contains(inputs.tag || github.ref, '-') }}
    steps:
      - name: Checkout homebrew-tap
        uses: actions/checkout@v4
        with:
          repository: TheBushidoCollective/homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap

      - name: Update formula
        env:
          VERSION: ${{ inputs.tag || github.ref_name }}
        run: |
          VERSION="${VERSION#v}"
          REPO="TheBushidoCollective/han"
          BASE_URL="https://github.com/${REPO}/releases/download/v${VERSION}"

          DARWIN_ARM64_SHA=$(curl -fsSL "${BASE_URL}/han-darwin-arm64.sha256" | awk '{print $1}')
          DARWIN_X64_SHA=$(curl -fsSL "${BASE_URL}/han-darwin-x64.sha256" | awk '{print $1}')
          LINUX_ARM64_SHA=$(curl -fsSL "${BASE_URL}/han-linux-arm64.sha256" | awk '{print $1}')
          LINUX_X64_SHA=$(curl -fsSL "${BASE_URL}/han-linux-x64.sha256" | awk '{print $1}')

          cat > homebrew-tap/Formula/han.rb << EOF
          # typed: false
          # frozen_string_literal: true

          class Han < Formula
            desc "Sophisticated Claude Code Plugins with Superior Accuracy"
            homepage "https://han.guru"
            version "${VERSION}"
            license "MIT"

            on_macos do
              if Hardware::CPU.arm?
                url "https://github.com/TheBushidoCollective/han/releases/download/v${VERSION}/han-darwin-arm64"
                sha256 "${DARWIN_ARM64_SHA}"
              else
                url "https://github.com/TheBushidoCollective/han/releases/download/v${VERSION}/han-darwin-x64"
                sha256 "${DARWIN_X64_SHA}"
              end
            end

            on_linux do
              if Hardware::CPU.arm?
                url "https://github.com/TheBushidoCollective/han/releases/download/v${VERSION}/han-linux-arm64"
                sha256 "${LINUX_ARM64_SHA}"
              else
                url "https://github.com/TheBushidoCollective/han/releases/download/v${VERSION}/han-linux-x64"
                sha256 "${LINUX_X64_SHA}"
              end
            end

            def install
              bin.install Dir["han-*"].first => "han"
            end

            test do
              assert_match version.to_s, shell_output("#{bin}/han --version")
            end
          end
          EOF

      - name: Commit and push
        working-directory: homebrew-tap
        env:
          TAG: ${{ inputs.tag || github.ref_name }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/han.rb
          git commit -m "Update han to ${TAG}"
          git push
